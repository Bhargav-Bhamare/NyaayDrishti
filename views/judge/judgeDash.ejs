<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NyaayDrishti- Judge Portal</title>
    <link rel="stylesheet" href="/CSS/Judge/style.css" type="text/css">
    <link rel="stylesheet" href="/CSS/dailyCauseList.css" type="text/css">
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 <!-- Embedded styles for Case Quick View (self-contained, gov-style) -->
 <style>
  :root{--bg:#fbfbf9;--panel:#ffffff;--muted:#6b7280;--accent:#0f172a}
  body{background:var(--bg);color:var(--accent);font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
  /* Daily cause list table */
  .daily-cause-section{margin-top:18px;background:var(--panel);border:1px solid #e6e9ef;padding:14px;border-radius:6px}
  .daily-cause-section h3{margin:0 0 8px 0;font-size:15px;color:var(--accent);font-weight:600}
  table.cause-table{width:100%;border-collapse:collapse;font-size:14px}
  table.cause-table thead th{background:#f3f4f6;padding:8px 10px;text-align:left;color:#111827;border-bottom:1px solid #e5e7eb;font-weight:600}
  table.cause-table tbody td{padding:10px;border-bottom:1px solid #f1f5f9}
  tr.cause-row{cursor:pointer}
  tr.cause-row:hover{background:#f8fafc}
  .case-meta{color:var(--muted);font-size:13px}

  /* Right-side sliding panel */
  .overlay{position:fixed;inset:0;background:rgba(15,23,42,0.45);opacity:0;visibility:hidden;transition:opacity .22s ease,visibility .22s}
  .overlay.open{opacity:1;visibility:visible}
  .case-panel{position:fixed;right:0;top:0;height:100vh;width:420px;max-width:96%;background:var(--panel);box-shadow:-8px 0 24px rgba(2,6,23,.12);transform:translateX(100%);transition:transform .28s ease;padding:20px;overflow:auto}
  .case-panel.open{transform:translateX(0)}
  .panel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .panel-title{font-size:17px;font-weight:700;color:var(--accent)}
  .close-btn{background:#f3f4f6;border:0;padding:6px 8px;border-radius:6px;cursor:pointer}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;font-weight:700;font-size:13px}
  .badge.urgent{background:#fff1f2;color:#dc2626;border:1px solid #fee2e2}
  .badge.regular{background:#fffbeb;color:#b45309;border:1px solid #fef3c7}
  .badge.low{background:#f0fdf4;color:#065f46;border:1px solid #dcfce7}
  .field-label{font-size:12px;color:var(--muted);margin-top:10px}
  .field-value{font-size:15px;color:#0f172a;margin-top:4px}
  .summary-box{background:#f8fafc;padding:10px;border-radius:6px;border:1px solid #eef2ff;color:#111827}
  .action-row{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
  .action-btn{background:#eef2ff;border:1px solid #dbeafe;color:#1e3a8a;padding:8px 10px;border-radius:6px;cursor:pointer;font-weight:600}
  .muted-note{font-size:13px;color:var(--muted);margin-top:8px}
  @media (max-width:640px){.case-panel{width:100%;max-width:100%}}
 </style>
 </head>
 <body>
  <div class="dashboard-container">
   <header class="dashboard-header">
    <div class="header-left">
     <div class="logo-icon">
      ‚öñÔ∏è
     </div>
     <div class="header-info">
      <div class="app-title">
       NyaayDrishti
      </div>
      <div class="judge-info">
       Justice Sharma | Court #3 |
      </div>
     </div>
    </div>
    <div class="current-time-display" id="currentTime">
     11:25 AM
    </div>
   </header><!-- Main Content -->
   <div class="main-content"><!-- Left Panel -->
    <div class="left-panel"><!-- Current Case Section -->
    <section class="current-case-section"><span class="section-badge">CURRENT CASE (In Progress)</span>
     <h2 id="current_caseTitle" class="case-title">Case #27834 - Criminal Bail Application</h2>
     <div id="current_petitioner" class="case-detail">
      <strong>Petitioner:</strong> Ram Kumar (32, unemployed)
     </div>
     <div id="current_respondent" class="case-detail">
      <strong>Respondent:</strong> State of Delhi
     </div>
     <div id="current_advocates" class="case-detail">
      <strong>Advocate:</strong> Adv. Thakur (Petitioner) | APP Singh (State)
     </div>
     <div id="current_status" class="status-indicator">
      üî¥ <span>IN PROGRESS</span>
     </div><!-- Time Tracking -->
        <!-- IDs added so JS can synchronise current case display -->
      
      <div class="time-tracking-box">
       <div class="time-row"><strong>Scheduled:</strong> 10:00 AM - 10:30 AM (30 minutes allocated)
       </div>
       <div class="time-row"><strong>Actual:</strong> 10:00 AM - <span id="currentActualTime">11:25 AM</span> (<span id="elapsedMinutes">85</span> minutes elapsed)
       </div>
       <div class="overrun-text">
        ‚ö†Ô∏è OVERRUN: <span id="overrunMinutes">+55</span> MINUTES
       </div>
       <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div><span class="progress-label" id="progressLabel">283%</span>
       </div>
      </div>
     </section><!-- Next Cases Section -->
     <section class="next-cases-section">
      <h3 class="next-case-header">NEXT CASES - QUICK VIEW</h3>
      <div class="next-case-item"><strong>Case 3 (Next):</strong> Case #27835 (Civil Suit - Property Dispute)<br>
        Was 10:45 AM, <strong>NOW <span id="case3Time">11:40 AM</span></strong> - <span class="notified-badge">NOTIFIED ‚úì</span>
      </div>
      <div class="next-case-item"><strong>Case 4:</strong> Case #27856 (Criminal - Theft)<br>
        Was 11:50 AM, <strong>NOW <span id="case4Time">12:35 PM</span></strong> - <span class="notified-badge">NOTIFIED ‚úì</span>
      </div>
     </section>
    </section>

    </div><!-- Left Panel end -->

    <!-- Case Quick View overlay + sliding panel (right) -->
    <div class="right-panel">
      <!-- Daily Cause List moved to right panel for easier access -->
      <section class="daily-cause-section">
        <h3>Daily Cause List</h3>
        <table class="cause-table" aria-describedby="dailyCauseDesc">
          <thead>
            <tr>
              <th>Case No</th>
              <th>Title</th>
              <th>Category</th>
              <th>Stage</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="causeTableBody">
            <!-- Rows rendered by JavaScript -->
          </tbody>
        </table>
        <div id="dailyCauseDesc" style="display:none">Click any row to open a read-only Case Quick View panel.</div>
      </section>

      <div id="caseOverlay" class="overlay" onclick="handleOverlayClick(event)"></div>
      <aside id="caseQuickView" class="case-panel" aria-hidden="true" role="dialog" aria-label="Case Quick View">
        <div class="panel-header">
          <div class="panel-title">Case Quick View</div>
          <div><button class="close-btn" onclick="closeCaseQuickView()" aria-label="Close">‚úï</button></div>
        </div>
        <div id="caseContent">
          <div class="field-label">Case Number</div>
          <div id="cv_caseNumber" class="field-value">‚Äî</div>

          <div class="field-label">Case Title</div>
          <div id="cv_caseTitle" class="field-value">‚Äî</div>

          <div class="field-label">Category & Priority</div>
          <div id="cv_priorityWrap" class="field-value"><span id="cv_category" class="case-meta">‚Äî</span> <span id="cv_priorityBadge" class="badge regular">Regular</span></div>

          <div class="field-label">Current Stage</div>
          <div id="cv_stage" class="field-value">‚Äî</div>

          <div class="field-label">Petitioner / Respondent</div>
          <div id="cv_parties" class="field-value case-meta">‚Äî</div>

          <div class="field-label">Advocates on record</div>
          <div id="cv_advocates" class="field-value case-meta">‚Äî</div>

          <div class="field-label">Short Case Summary</div>
          <div id="cv_summary" class="summary-box">‚Äî</div>

          <div class="field-label">Last Order</div>
          <div id="cv_lastOrder" class="field-value case-meta">‚Äî</div>

          <div class="action-row">
            <button class="action-btn" onclick="onAction('fullFile')">View Full Case File</button>
            <button class="action-btn" onclick="onAction('evidence')">View Evidence List</button>
            <button class="action-btn" onclick="onAction('witness')">View Witness List</button>
            <button class="action-btn" onclick="onAction('timeline')">View Case Timeline</button>
          </div>
          <div class="muted-note">Read-only quick reference. Use full case file for decisions.</div>
        </div>
      </aside>
    </div>
   </div><!-- Bottom Status Bar -->
   <footer class="status-bar">
    <div class="stat-item">
     <div class="stat-value">
      21 ‚úì
     </div>
     <div class="stat-label">
      Cases Disposed Today
     </div>
    </div>
    <div class="stat-item">
     <div class="stat-value">
      5
     </div>
     <div class="stat-label">
      Cases Adjourned Today
     </div>
    </div>
    <div class="stat-item">
     <div class="stat-value">
      45 min
     </div>
     <div class="stat-label">
      Average Time per Case
     </div>
    </div>
    <div class="stat-item">
     <div class="stat-value" style="color: #10B981;">
      91% ‚úì
     </div>
     <div class="stat-label">
      Disposal Rate
     </div>
    </div>
   </footer>
  </div>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/JS/Judge/script.js"></script>
  <script src="/JS/dailyCauseList.js"></script>
  <script>
    // Placeholder case data for demo / hackathon
    let CASES = [];

    // Load Daily Cause List from priority engine
    async function loadDailyCauseList() {
      try {
        const response = await fetch('/api/daily-cause-list?availableMinutes=300');
        if (!response.ok) throw new Error('Failed to load daily cause list');
        
        const data = await response.json();
        const causeList = data && data.data && data.data.dailyCauseList ? data.data.dailyCauseList : [];

        // Defensive transform to CASES format (guard against missing fields)
        if (!Array.isArray(causeList)) {
          console.warn('Daily cause list not an array:', causeList);
        }

        CASES = (causeList || []).map((item, index) => {
          // log raw item when fields are missing for debugging
          if (!item || !item.caseNumber) {
            console.warn('Malformed case item in dailyCauseList at index', index, item);
          }

          const priorityScore = item && item.priority && typeof item.priority.score === 'number' ? item.priority.score : 0;

          return {
            id: (item && item._id) ? String(item._id) : `C${index}`,
            caseNumber: item && item.caseNumber ? item.caseNumber : `UNDEF-${index}`,
            title: `${(item && item.caseType) || 'Unknown'} - ${(item && item.petitioner) || '‚Äî'} v/s ${(item && item.respondent) || '‚Äî'}`,
            category: (item && item.caseType) || 'Unknown',
            priority: getPriorityLevel(priorityScore),
            stage: (item && item.stage) || 'Unknown',
            petitioner: (item && item.petitioner) || '‚Äî',
            respondent: (item && item.respondent) || '‚Äî',
            advocates: ['Advocate 1', 'Advocate 2'],
            summary: `Case Type: ${(item && item.caseType) || '‚Äî'}. Petitioner: ${(item && item.petitioner) || '‚Äî'}. Respondent: ${(item && item.respondent) || '‚Äî'}. Stage: ${(item && item.stage) || '‚Äî'}. Priority Score: ${(priorityScore * 100).toFixed(1)}%.`,
            lastOrder: item && item.startTime ? `Scheduled for ${item.startTime} to ${item.endTime}` : 'No schedule',
            time: (item && item.startTime) || '',
            estimatedTime: (item && item.estimatedTime) || 0,
            priorityScore: priorityScore,
            priorityReasoning: (item && item.priority && item.priority.reasoning) || (item && item.priorityReasoning) || []
          };
        });

        renderCauseTable();
        if (CASES.length) openCaseQuickView(CASES[0].id, false);
      } catch (error) {
        console.error('Error loading daily cause list:', error);
        // Show error message
        document.getElementById('causeTableBody').innerHTML = 
          '<tr><td colspan="5" style="text-align:center; color:red;">Error loading cause list</td></tr>';
      }
    }

    function getPriorityLevel(score) {
      if (score >= 0.85) return 'urgent';
      if (score >= 0.60) return 'regular';
      return 'low';
    }

    // Render daily cause list into table
    function renderCauseTable() {
      const tbody = document.getElementById('causeTableBody');
      tbody.innerHTML = '';
      CASES.forEach(c => {
        const tr = document.createElement('tr');
        tr.className = 'cause-row';
        tr.setAttribute('data-case-id', c.id);
        tr.tabIndex = 0;
        tr.innerHTML = `
          <td><strong>${escapeHtml(c.caseNumber)}</strong></td>
          <td>${escapeHtml(c.title)}<div class="case-meta">${escapeHtml(c.petitioner)} v/s ${escapeHtml(c.respondent)}</div></td>
          <td>${escapeHtml(c.category)}</td>
          <td>${escapeHtml(c.stage)}</td>
          <td class="case-meta">${escapeHtml(c.time)}</td>
        `;
        tr.addEventListener('click', () => openCaseQuickView(c.id));
        tr.addEventListener('keypress', (e) => { if (e.key === 'Enter') openCaseQuickView(c.id); });
        tbody.appendChild(tr);
      });
    }

    function escapeHtml(text) {
      if (!text && text !== 0) return '';
      return String(text).replace(/[&<>"']/g, function (s) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]); });
    }

    // Open the Case Quick View by id
    // showOverlay: boolean ‚Äî if true, dim background and allow outside-click to close (modal style)
    function openCaseQuickView(caseId, showOverlay = false) {
      const c = CASES.find(x => x.id === caseId);
      if (!c) return console.warn('Case not found', caseId);
      // Populate fields
      document.getElementById('cv_caseNumber').textContent = c.caseNumber;
      document.getElementById('cv_caseTitle').textContent = c.title;
      document.getElementById('cv_category').textContent = c.category;
      const badge = document.getElementById('cv_priorityBadge');
      badge.textContent = (c.priority === 'urgent') ? 'üî¥ Urgent' : (c.priority === 'regular' ? 'üü° Regular' : 'üü¢ Low');
      badge.className = 'badge ' + (c.priority === 'urgent' ? 'urgent' : (c.priority === 'regular' ? 'regular' : 'low'));
      document.getElementById('cv_stage').textContent = c.stage;
      document.getElementById('cv_parties').textContent = c.petitioner + ' ‚Äî ' + c.respondent;
      document.getElementById('cv_advocates').textContent = (c.advocates || []).join(' | ');
      document.getElementById('cv_summary').textContent = c.summary || generateSummary(c);
      
      // Add priority details
      const priorityDetailsEl = document.createElement('div');
      priorityDetailsEl.innerHTML = `
        <div class="field-label" style="margin-top: 15px; border-top: 1px solid #e5e7eb; padding-top: 10px;">Priority Score</div>
        <div class="field-value" style="color: #d32f2f; font-weight: bold; font-size: 18px;">
          ${(c.priorityScore * 100).toFixed(1)}%
        </div>
        <div class="field-label">Priority Factors</div>
        <div style="font-size: 13px; color: #666; line-height: 1.5;">
          ${c.priorityReasoning.map(r => `‚Ä¢ ${r}`).join('<br>')}
        </div>
      `;
      const summaryDiv = document.getElementById('cv_summary').parentElement;
      const existingDetails = summaryDiv.querySelector('.priority-details-insert');
      if (existingDetails) existingDetails.remove();
      priorityDetailsEl.className = 'priority-details-insert';
      summaryDiv.appendChild(priorityDetailsEl);
      
      document.getElementById('cv_lastOrder').textContent = c.lastOrder || 'No recent order.';

      // Sync left 'current case' display
      syncCurrentCaseDisplay(c);

      // Show panel (sliding). Overlay only if explicitly requested.
      const overlay = document.getElementById('caseOverlay');
      if (showOverlay) overlay.classList.add('open'); else overlay.classList.remove('open');
      const panel = document.getElementById('caseQuickView');
      panel.classList.add('open');
      panel.setAttribute('aria-hidden', 'false');
    }

    // Keep left panel current-case section synced with selected case
    function syncCurrentCaseDisplay(c) {
      const titleEl = document.getElementById('current_caseTitle');
      const petEl = document.getElementById('current_petitioner');
      const respEl = document.getElementById('current_respondent');
      const advEl = document.getElementById('current_advocates');
      const statusEl = document.getElementById('current_status');
      if (titleEl) titleEl.textContent = `Case #${c.caseNumber} - ${c.title}`;
      if (petEl) petEl.innerHTML = `<strong>Petitioner:</strong> ${escapeHtml(c.petitioner)}`;
      if (respEl) respEl.innerHTML = `<strong>Respondent:</strong> ${escapeHtml(c.respondent)}`;
      if (advEl) advEl.innerHTML = `<strong>Advocate:</strong> ${escapeHtml((c.advocates||[]).join(' | '))}`;
      if (statusEl) statusEl.innerHTML = `${c.priority === 'urgent' ? 'üî¥' : c.priority === 'regular' ? 'üü°' : 'üü¢'} <span>${escapeHtml(c.stage)}</span>`;
    }

    // Close the quick view
    function closeCaseQuickView() {
      document.getElementById('caseOverlay').classList.remove('open');
      const panel = document.getElementById('caseQuickView');
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden', 'true');
    }

    // Close when clicking outside (overlay) ‚Äî only if overlay itself was clicked
    function handleOverlayClick(e) {
      if (e.target && e.target.id === 'caseOverlay') closeCaseQuickView();
    }

    // Placeholder action handlers (read-only navigation)
    function onAction(action) {
      console.log('Placeholder action:', action);
      // For demo, flash the button or show a temporary message
      // In production this would navigate to full views
    }

    // Simple summary generator if not provided
    function generateSummary(c) {
      return `${c.title} ‚Äî ${c.petitioner} v/s ${c.respondent}. Category: ${c.category}. Current stage: ${c.stage}.`;
    }

    // Close on Escape
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeCaseQuickView(); });

    // Initial render ‚Äî load from API
    document.addEventListener('DOMContentLoaded', () => {
      loadDailyCauseList();
    });

    // Refresh cause list every 30 seconds
    setInterval(loadDailyCauseList, 30000);
  </script>
</body>
</html>